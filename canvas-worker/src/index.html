<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UGS Watcher</title>
  <style>
    :root { --bg:#0b1020; --card:#141a2e; --fg:#e6e9f0; --muted:#9aa3b2; --acc:#5b8cff; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    .nav { display:flex; gap:.5rem; align-items:center; padding:1rem; background:#0f1530; position:sticky; top:0; }
    .brand { font-weight:700; letter-spacing:.3px; margin-right:auto; }
    button, .btn { background: var(--acc); border:none; color:white; padding:.55rem .9rem; border-radius:.6rem; cursor:pointer; text-decoration:none; }
    button.secondary { background:#2a3354; }
    main { max-width:900px; margin:2rem auto; padding:0 1rem; }
    .row { display:flex; gap:.5rem; align-items:center; margin:1rem 0; }
    input[type=text] { flex:1; padding:.6rem .7rem; border-radius:.6rem; border:1px solid #2a3354; background:#10162b; color:var(--fg); }
    pre { background: var(--card); padding:1rem; border-radius:.8rem; overflow:auto; }
    small { color: var(--muted); }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">UGS Watcher</div>
    <a class="btn" id="statusBtn" href="#">Status</a>
    <a class="btn" id="stopBtn" href="#">Stop</a>
  </nav>
  <main>
    <h2>Start Watching</h2>
    <div class="row">
        <input id="cookies" type="text" placeholder="Paste COOKIES_JSON (raw cookie string)" />
        <button id="startBtn">Start</button>
    </div>
    <div class="row">
        <button id="showBtn" class="secondary" disabled>Apply Saved Cookies</button>
        <button id="copyBtn" class="secondary" disabled>Copy</button>
    </div>

    <small>Tip: This stores the cookie string inside the Durable Object (not as a Wrangler secret).</small>
    <a href="https://utexas.instructure.com/courses/1431941/quizzes" target="_blank" rel="noopener noreferrer">Open UGS Quizzes</a>

    <h3>Status</h3>
    <pre id="status">(loading...)</pre>
  </main>

<script>
async function fetchJSON(u, init) {
  const r = await fetch(u, init);
  const t = await r.text();
  try { return { ok:r.ok, data: JSON.parse(t) }; } catch { return { ok:r.ok, data: t }; }
}

document.getElementById('stopBtn').onclick = async (e) => {
  e.preventDefault();
  const r = await fetch('/stop', { method:'POST' });
  const { ok, data } = await fetchJSON('/status');
  document.getElementById('status').textContent = (ok ? 'Stopped.\n' : 'Stop failed.\n') + JSON.stringify(data, null, 2);
};
document.getElementById('startBtn').onclick = async () => {
  const cookies = (document.getElementById('cookies').value || '').trim();
  if (!cookies) { alert('Please paste your COOKIES_JSON string.'); return; }
  const form = new URLSearchParams(); form.set('cookies', cookies);
  await fetch('/start', { method:'POST', headers:{'content-type':'application/x-www-form-urlencoded'}, body: form });
  const { ok, data } = await fetchJSON('/status');
  document.getElementById('status').textContent = ok ? 'Started.\n' + JSON.stringify(data, null, 2) : 'Start failed.';
};

async function refreshStatus() {
  const { ok, data } = await fetchJSON('/status');
  const cookiesInput = document.getElementById('cookies');
  const showBtn = document.getElementById('showBtn');
  const copyBtn = document.getElementById('copyBtn');

  if (ok && data) {
    document.getElementById('status').textContent = JSON.stringify(data, null, 2);

    if (data.cookiesFull) {
      cookiesInput.value = data.cookiesFull;
      cookiesInput.dataset.full = data.cookiesFull;
      showBtn.disabled = false;
      copyBtn.disabled = false;
    } else {
      cookiesInput.value = '';
      cookiesInput.dataset.full = '';
      showBtn.disabled = true;
      copyBtn.disabled = true;
    }
  } else {
    document.getElementById('status').textContent = 'Failed to load status.';
  }
}

document.getElementById('showBtn').onclick = (e) => {
  e.preventDefault();
  const input = document.getElementById('cookies');
  const full = input.dataset.full || '';
  input.value = full ? full : '(none)';
};

document.getElementById('copyBtn').onclick = async (e) => {
  e.preventDefault();
  const full = document.getElementById('cookies').dataset.full || '';
  if (!full) return alert('No cookie to copy');
  await navigator.clipboard.writeText(full);
  e.target.textContent = 'Copied!';
  setTimeout(() => (e.target.textContent = 'Copy'), 1200);
};

document.getElementById('statusBtn').onclick = (e) => {
  e.preventDefault();
  refreshStatus();
};

window.addEventListener('load', refreshStatus);
</script>
</body>
</html>
